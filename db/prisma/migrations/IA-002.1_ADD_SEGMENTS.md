# Migration IA-002.1: Add User Segmentation

## Description

This migration adds user segmentation fields to the `UserVector` model to support cold start recommendations.

## Changes

### UserVector Model

Added fields:
- `segments` (Json, nullable): Array of segment assignments with scores and reasons
- `primarySegment` (String, nullable): Main segment identifier
- `segmentConfidence` (Float, nullable): Confidence score [0-1]
- `lastSegmentUpdate` (DateTime, nullable): Timestamp of last segment recalculation

Added index:
- `primarySegment`: For efficient segment-based queries

## Migration Commands

### 1. Create Migration

```bash
cd dreamscape-services/db
npx prisma migrate dev --name add_user_segments
```

This will:
- Generate SQL migration files
- Apply migration to development database
- Regenerate Prisma Client

### 2. Apply to Production

```bash
npx prisma migrate deploy
```

### 3. Rollback (if needed)

Prisma doesn't support automatic rollbacks. To revert:

```bash
# Manually edit schema.prisma to remove the fields
# Then create a new migration
npx prisma migrate dev --name remove_user_segments
```

## SQL Migration (Manual Reference)

If you need to apply manually:

```sql
-- Add new columns to user_vectors table
ALTER TABLE "user_vectors"
ADD COLUMN "segments" JSONB,
ADD COLUMN "primarySegment" TEXT,
ADD COLUMN "segmentConfidence" DOUBLE PRECISION,
ADD COLUMN "lastSegmentUpdate" TIMESTAMP(3);

-- Add index for segment-based queries
CREATE INDEX "user_vectors_primarySegment_idx" ON "user_vectors"("primarySegment");
```

## Data Migration

After applying the schema migration, run the data migration script:

```bash
cd dreamscape-services/ai
node scripts/migrate-existing-vectors.js
```

This script will:
1. Fetch all existing UserVector records
2. Retrieve user onboarding profiles
3. Calculate segments using SegmentEngineService
4. Update UserVector with segment data

## Validation

After migration, verify:

```sql
-- Check schema changes
\d user_vectors

-- Count records with segments assigned
SELECT
  COUNT(*) as total,
  COUNT("primarySegment") as with_segments,
  ROUND(COUNT("primarySegment")::numeric / COUNT(*)::numeric * 100, 2) as percentage
FROM user_vectors;

-- Distribution of primary segments
SELECT
  "primarySegment",
  COUNT(*) as count,
  ROUND(AVG("segmentConfidence"), 2) as avg_confidence
FROM user_vectors
WHERE "primarySegment" IS NOT NULL
GROUP BY "primarySegment"
ORDER BY count DESC;
```

## Rollback Plan

If issues occur:

1. **Schema rollback**: Remove columns (data will be lost)
```sql
ALTER TABLE "user_vectors"
DROP COLUMN "segments",
DROP COLUMN "primarySegment",
DROP COLUMN "segmentConfidence",
DROP COLUMN "lastSegmentUpdate";

DROP INDEX "user_vectors_primarySegment_idx";
```

2. **Application rollback**: Deploy previous version without segment features

3. **Data recovery**: Segments can be recalculated from onboarding data anytime

## Testing

Before production deployment:

1. Test migration on staging database
2. Verify data migration script works correctly
3. Check API endpoints return segment data
4. Validate performance (should be minimal impact)

## Backward Compatibility

This migration is **backward compatible**:
- All new fields are nullable
- Existing queries will continue to work
- Applications can check for segment presence before using

## Dependencies

- Prisma ^5.x
- PostgreSQL ^14.x
- Node.js ^18.x

## Related Tickets

- IA-002.1: User Segmentation
- IA-002.2: Popularity-based Recommendations
- IA-002.3: Onboarding Integration

## Migration Author

AI Service Team

## Migration Date

2026-01-29
