name: CI/CD Trigger for Services

on:
  push:
    branches: [main, dev, develop, feature/**, bugfix/**, hotfix/**]
  pull_request:
    branches: [main, dev, develop]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  statuses: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  INFRA_REPO: DREAMSCAPE-AI/dreamscape-infra

jobs:
  # ============================================================
  # Local CI: Fast validation before triggering central pipeline
  # ============================================================
  local-ci:
    name: Local CI & Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft != true
    outputs:
      changed_services: ${{ steps.changes.outputs.changed_services }}
      should_trigger: ${{ steps.check.outputs.should_trigger }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Detect changed services
        id: changes
        run: |
          CHANGED_SERVICES=""

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            if [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
            else
              CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
            fi
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Detect which services were changed
          for service in auth user voyage payment ai panorama; do
            if echo "$CHANGED_FILES" | grep -qE "^(${service}/|${service}-service/)"; then
              if [[ -z "$CHANGED_SERVICES" ]]; then
                CHANGED_SERVICES="$service"
              else
                CHANGED_SERVICES="$CHANGED_SERVICES,$service"
              fi
            fi
          done

          # Check for shared/db changes affecting all services
          if echo "$CHANGED_FILES" | grep -qE "^(shared/|db/)"; then
            CHANGED_SERVICES="all"
          fi

          # If no specific service changed but files changed, mark as all
          if [[ -z "$CHANGED_SERVICES" ]] && [[ -n "$CHANGED_FILES" ]]; then
            CHANGED_SERVICES="all"
          fi

          echo "changed_services=${CHANGED_SERVICES}" >> $GITHUB_OUTPUT
          echo "âœ… Detected changes: ${CHANGED_SERVICES}"

      - name: Check if central pipeline should be triggered
        id: check
        run: |
          if [[ -z "${{ steps.changes.outputs.changed_services }}" ]]; then
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No changes detected, skipping central pipeline"
          elif [[ "${{ github.event_name }}" == "pull_request" ]] && [[ -z "${{ secrets.DISPATCH_TOKEN }}" ]]; then
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ PR from fork or missing token, skipping dispatch (normal behavior)"
          else
            echo "should_trigger=true" >> $GITHUB_OUTPUT
            echo "âœ… Will trigger central pipeline"
          fi

      - name: Lint changed services
        if: steps.changes.outputs.changed_services != ''
        run: |
          SERVICES="${{ steps.changes.outputs.changed_services }}"

          if [[ "${SERVICES}" == "all" ]]; then
            SERVICES="auth,user,voyage,payment,ai,panorama"
          fi

          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            SERVICE_DIR="${service}"
            [[ ! -d "${SERVICE_DIR}" ]] && SERVICE_DIR="${service}-service"

            if [[ -d "${SERVICE_DIR}" ]] && [[ -f "${SERVICE_DIR}/package.json" ]]; then
              echo "ðŸ” Linting ${service}..."
              (cd "${SERVICE_DIR}" && npm install && npm run lint --if-present) || echo "âš ï¸ Lint issues in ${service}"
            fi
          done

  # ============================================================
  # Trigger Central Pipeline
  # ============================================================
  trigger-central-pipeline:
    name: Trigger Central CI/CD
    runs-on: ubuntu-latest
    needs: local-ci
    if: needs.local-ci.outputs.should_trigger == 'true'
    steps:
      - name: Determine environment
        id: env
        run: |
          case "${{ github.ref }}" in
            refs/heads/main)
              echo "environment=production" >> $GITHUB_OUTPUT
              ;;
            refs/heads/develop)
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=dev" >> $GITHUB_OUTPUT
              ;;
          esac

          # PRs always target dev
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Trigger unified CI/CD pipeline
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISPATCH_TOKEN }}
          script: |
            const payload = {
              source_repo: `${context.repo.owner}/${context.repo.repo}`,
              ref: context.ref,
              sha: context.sha,
              component: '${{ needs.local-ci.outputs.changed_services }}',
              environment: '${{ steps.env.outputs.environment }}',
              trigger_type: '${{ github.event_name }}',
              actor: context.actor,
              workflow_run_id: context.runId
            };

            console.log('ðŸ“¤ Triggering central pipeline:', payload);

            try {
              await github.rest.repos.createDispatchEvent({
                owner: 'DREAMSCAPE-AI',
                repo: 'dreamscape-infra',
                event_type: 'services-changed',
                client_payload: payload
              });

              console.log('âœ… Central pipeline triggered successfully');

              // Set pending status
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'pending',
                target_url: 'https://github.com/DREAMSCAPE-AI/dreamscape-infra/actions',
                description: 'Central CI/CD pipeline triggered',
                context: 'ci/unified-pipeline'
              });

            } catch (error) {
              console.error('âŒ Failed to trigger central pipeline:', error);

              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'error',
                description: 'Failed to trigger central CI/CD',
                context: 'ci/unified-pipeline'
              });

              throw error;
            }

  # ============================================================
  # Summary
  # ============================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [local-ci, trigger-central-pipeline]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "# ðŸ“Š Services CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Services**: ${{ needs.local-ci.outputs.changed_services }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.trigger-central-pipeline.result }}" == "success" ]]; then
            echo "âœ… Central CI/CD pipeline triggered successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [View Pipeline Progress](https://github.com/DREAMSCAPE-AI/dreamscape-infra/actions)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.trigger-central-pipeline.result }}" == "skipped" ]]; then
            echo "â„¹ï¸ Central pipeline trigger skipped (no changes or PR from fork)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to trigger central CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
          fi
